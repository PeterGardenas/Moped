#!/bin/bash

#export JAVA_HOME=/usr/local/jvm/jdk1.8.0

GCC_FLAG="-comp:gcc-rpi"

while getopts vcron option
do
        case "${option}"
        in
                v) VERBOSE="-verbose";;
                c) COMPILE="true";;
		r) RUN="true";;
		o) OUTPUT="output.txt";;
		n) GCC_FLAG="";;
        esac
done

if [[ "${OUTPUT}" == "output.txt" ]]; then
if [ -a output.txt ]; then
rm output.txt
fi
exec 1>>${OUTPUT} 2>&1
fi

if [[ "${COMPILE}" == "true" || "${RUN}" != "true" ]]; then
# Remove trash
#./d.sh clean

# Build the Builder
cd builder
./bld.sh
cd ..

# Copy Phoneme
./d.sh copyphoneme 

# Build the Squawk executable
./d.sh
#./d.sh ${GCC_FLAG} -prod -mac ${VERBOSE} rom -metadata cldc debugger 
./d.sh ${GCC_FLAG} -prod -mac ${VERBOSE} rom -metadata cldc imp debugger
./createSquawkArray.sh
./d.sh ${GCC_FLAG} -prod -mac ${VERBOSE} rom -metadata cldc imp debugger
fi

if [ "${RUN}" == "true" ]; then
# Build the suite
./d.sh user-clean tests/ClassLoaderInput
./d.sh user-suite tests/ClassLoaderInput

# Run the suite
if [ "${GCC_FLAG}" == "" ]; then
./squawk -suite:tests/ClassLoaderInput/ClassLoaderInput tests.ClassLoaderInput
else 
#./squawk plugin://tests/ClassLoaderInput/ClassLoaderInput.suite -34, -83, -66, -17, 0, 1, 0, 1, 0, 0, 0, 2, 0, 125, 54, -41, 0, 16, 109, 101, 109, 111, 114, 121, 58, 98, 111, 111, 116, 115, 116, 114, 97, 112, 0, 0, 0, 4, 0, 0, 3, 0, -17, -25, -1, 11, -4, 63, 5, -128, 83, 40, 64, -1, 23, 4, 4, 0, 1, 8, 0, 65, 8, 126, 1, -96, 0, 0, 64, -87, 1, 0, 96, -118, 6, 0, -72, -116, 6, 0, -48, -116, 6, 0, 1, 0, 0, 0, 4, 0, 0, 0, 32, -115, 6, 0, 40, -115, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, -118, 6, 0, 1, 0, 0, 0, 5, 0, 0, 0, 108, 109, 0, 0, 104, -118, 6, 0, -44, 109, 0, 0, 104, -118, 6, 0, -76, -118, 6, 0, 40, -117, 6, 0, -36, -67, 5, 0, 0, 0, 0, 0, 100, 9, 0, 0, -48, 12, 0, 0, -124, -117, 6, 0, -116, -117, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 33, 80, 0, 0, 0, 0, -1, -1, 0, 0, 0, 0, 0, 0, 4, 9, 45, 0, 0, 0, 56, 58, 1, 0, -20, 9, 0, 0, 8, 10, 0, 0, 36, 10, 0, 0, 76, 10, 0, 0, -100, 10, 0, 0, -72, 10, 0, 0, -28, 10, 0, 0, 0, 11, 0, 0, 36, 11, 0, 0, 92, 11, 0, 0, -12, -118, 6, 0, 23, 0, 0, 0, 0, 7, 66, 4, 104, -118, 6, 0, -83, 0, 0, 0, -32, -51, 2, 0, -72, 1, 17, -122, 2, 49, 21, 33, -88, 38, 17, -122, 2, 49, 22, 33, -88, 38, 17, -122, 2, 49, 23, 33, -88, 38, 17, -122, 2, 49, 25, 33, -88, 38, 17, -122, 2, 49, 24, 33, -88, 38, -67, 0, 9, 0, 0, 0, 56, 58, 1, 0, 68, -117, 6, 0, 96, -117, 6, 0, 23, 0, 0, 0, 0, 3, 34, 4, 104, -118, 6, 0, 33, 0, 0, 0, -32, -51, 2, 0, -61, 64, 16, -82, 0, -30, 64, -64, 23, 0, 0, 0, 0, 15, 99, 4, 104, -118, 6, 0, 113, 0, 0, 0, -32, -51, 2, 0, -72, 2, 17, -122, 2, 49, 20, 33, -88, 38, 18, -23, 18, -82, 0, 50, 34, -88, 10, 17, -122, 2, 49, 19, 33, -88, 38, -67, 1, 0, 0, 0, -116, 124, 2, 0, 41, 0, 0, 0, 56, 58, 1, 0, 100, 9, 0, 0, -108, 53, 1, 0, 104, -118, 6, 0, -68, -117, 6, 0, -44, -117, 6, 0, -12, -117, 6, 0, 44, -116, 6, 0, 88, -116, 6, 0, -116, -116, 6, 0, -92, -116, 6, 0, 53, 0, 0, 0, 120, -53, 2, 0, 67, 76, 73, 45, 109, 97, 105, 110, 32, 100, 111, 110, 101, 0, 0, 0, 93, 0, 0, 0, 120, -53, 2, 0, 67, 108, 97, 115, 115, 76, 111, 97, 100, 101, 114, 73, 110, 112, 117, 116, 46, 109, 97, 105, 110, 40, 41, 0, -67, 0, 0, 0, 120, -53, 2, 0, 72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100, 32, 102, 114, 111, 109, 32, 67, 108, 97, 115, 115, 76, 111, 97, 100, 101, 114, 73, 110, 112, 117, 116, 32, 40, 111, 110, 108, 121, 32, 98, 121, 116, 101, 115, 41, 33, 0, -115, 0, 0, 0, 120, -53, 2, 0, 73, 115, 32, 105, 116, 32, 114, 101, 97, 108, 108, 121, 32, 119, 111, 114, 107, 105, 110, 103, 32, 100, 121, 110, 97, 109, 105, 99, 97, 108, 108, 121, 63, 63, 63, 0, -79, 0, 0, 0, 120, -53, 2, 0, 79, 104, 44, 32, 121, 101, 115, 44, 32, 105, 116, 32, 105, 115, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 33, 65, 0, 0, 0, 120, -53, 2, 0, 83, 104, 117, 122, 104, 111, 117, 32, 105, 115, 32, 98, 97, 99, 107, 33, 45, 0, 0, 0, 120, -53, 2, 0, 90, 101, 32, 105, 115, 32, 104, 101, 114, 101, 33, 0, 65, 0, 0, 0, 120, -53, 2, 0, 67, 108, 97, 115, 115, 76, 111, 97, 100, 101, 114, 73, 110, 112, 117, 116, 5, 0, 0, 0, 44, -68, 1, 0, -40, -116, 6, 0, -100, -68, 1, 0, 104, -118, 6, 0, -20, -116, 6, 0, 96, -118, 6, 0, -91, 0, 0, 0, 4, -4, 0, 0, 12, 2, 15, 1, 10, 11, 112, 114, 105, 110, 116, 83, 116, 114, 105, 110, 103, 10, 3, 11, -119, 32, 0, 6, 60, 105, 110, 105, 116, 62, 1, 9, 9, 1, 4, 109, 97, 105, 110, 10, 34, 0, 0, 0, 1, 0, 0, 0, 56, -15, 1, 0, 1, 0, 0, 0, -56, -16, 1, 0
rm temp.txt
./printForJava tests/ClassLoaderInput/ClassLoaderInput.suite >> temp.txt
./squawk plugin://tests/ClassLoaderInput/ClassLoaderInput.suite $(<temp.txt)
rm temp.txt
fi
fi
